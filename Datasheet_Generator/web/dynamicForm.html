<!DOCTYPE html>
<!-- contains form and login code -->
<html>
    
    <head>
        <title>Owl</title>
        <link rel="shortcut icon" href="images/logo-Owl-Color_cropped.ico">
        <link href="css/bootstrap.min.css" rel="stylesheet" media="screen">
        <link href="css/bootstrap-responsive.min.css" rel="stylesheet" media="screen">
        <style>
            #viewButton a{color:#FFFFFF;}
            #viewButton a:link {text-decoration:none;}
            #viewButton a:visited {text-decoration:none;}
            #viewButton a:hover {text-decoration:none;}
            #viewButton a:active {text-decoration:none;}
        </style>
    </head>
    
    <body class="container">
        
        <div class="navbar navbar-fixed-top">
            <div class="navbar-inner"> 
                <div class="container">
                    <a class="brand" href="index.html">Owl</a>
                    <ul class="nav">
                        <li><a href="editExisting.html">Search Existing Parts</a></li>
                        <li class="active"><a href="dynamicForm.html">Create Datasheet</a></li>
                        <li><a href="contact.html">Contact</a></li>
                    </ul> 
                    <div id="loginArea">
                        <form id="loginForm" class="navbar-form pull-right" action="AuthenticationServlet" method="POST">
                            <input name="user" type="text" class="span2" placeholder="Login">
                            <input name="password" type="password" class="span2" placeholder="Password">
                            <input type="submit" value="Login" class="btn"/>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="page-header" style="margin-top:60px">
            <h1><img style="width: 48px; height: 40px; margin-bottom:5px" src="images/logo-Owl-Color_cropped.png"> <small> Build your Datasheet here</small></h1>
        </div>
        <div id="config">
                <div style="margin-bottom:10px"><h4>Upload a Configuration File</h4></div>
                <input type="file" id="files" name ="file" accept="text/plain" />
                <div><button class="btn btn-primary" id="uploadButton" style="margin-top:7px" onclick="readConfig()">Upload</button>
                <img id = "loading" style = "position:relative; padding-top:2px; padding-left:10px;" src ="images/ajax-loader.gif" hidden></div>
        </div>
        <div id="output" hidden>
            <div class="tabbable tabs-left">
                <ul id ="wellTabs" class="nav nav-tabs nav-pills well">
                </ul>
                <div class="tab-content" id="tabs">
                </div>
            </div>
        </div>

        <script>
            function readConfig(){

            var files = document.getElementById('files').files;
            if (!files.length) {
                alert('Please select a file!');
                return;
            }else{
                $('#loading').show();
            }

                var file = files[0];
                var start = 0;
                var stop = file.size;

                var reader = new FileReader();

                reader.onloadend = function(evt){
                    if (evt.target.readyState == FileReader.DONE) {
                        $('#config').addClass("hidden");
                        var info = evt.target.result.toLowerCase().trim();
                        idString = info;
                        info = info.replace(new RegExp("<well>","g"),"");
                        var count = info.match(/\/well/g);
                        info = info.split("</well>");
                        for (var i = 0; i < count.length; i++) {
                            var well = info[i];
                            var start = well.indexOf("<title>") + 7;
                            var stop = well.indexOf("</title>");
                            if (start == -1 || stop == -1){
                                alert("You must choose a title for each well!");
                                return;
                                // $('#config').removeClass("hidden");
                                // $('#config').show();
                                break;
                            }
                            var titleString = well.substring(start,stop);
                            titleString = titleString.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1);}).trim();
                            var camelTitle = (titleString.substr(0,1).toLowerCase() + titleString.substr(1)).replace(/ /g,"");

                            if (i == 0){
                                document.getElementById('wellTabs').innerHTML = document.getElementById('wellTabs').innerHTML + "<li id =\"" +
                                camelTitle + "Tab" + "\"" + " class=\"active\">" + "<a data-toggle=\"tab\" href=\"#" + camelTitle + "\">" +
                                titleString + "</a></li>" + "\n";

                                document.getElementById('tabs').innerHTML = document.getElementById('tabs').innerHTML + "<div id=\"" + camelTitle +
                                "\" class=\"active tab-pane\" style=\"margin-top:-15px\">" + "\n" + "<h2>" + titleString + "</h2>" + "\n" +
                                "<div class=\"well\" id=\"" + i + "\">";
                            } else{
                                document.getElementById('wellTabs').innerHTML = document.getElementById('wellTabs').innerHTML + "<li id =\"" +
                                camelTitle + "Tab" + "\">" + "<a data-toggle=\"tab\" href=\"#" + camelTitle + "\">" + titleString + "</a></li>" + "\n";

                                document.getElementById('tabs').innerHTML = document.getElementById('tabs').innerHTML + "<div id=\"" + camelTitle +
                                "\" class=\"tab-pane\" style=\"margin-top:-15px\">" + "\n" + "<h2>" + titleString + "</h2>" + "\n" +
                                "<div class=\"well\" id=\"" + i + "\">";
                            }


                            var fieldCount = well.match(/\//g);
                            well = well.replace(new RegExp("\n","g"),"");
                            well = well.split("/");
                            for (var j = 0; j < fieldCount.length; j++){
                                var field = well[j];
                                var begin = field.indexOf("<");
                                var end = field.length -1;
                                if (begin == -1 || end == -1){
                                    alert("Make sure all tags are enclosed in < > and ending tags begin with /");
                                    return;
                                    // $('#config').removeClass("hidden");
                                    break;
                                }
                                field = field.substring(begin,end);
                                var demo = field.substring(field.indexOf(">") + 1,field.length);
                                var tag = field.substring(field.indexOf("<") + 1,field.indexOf(">"));
                                var heading = field.substring(field.indexOf(">") + 1,field.length);
                                heading = heading.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1);}).trim();
                                var upperHeading = heading.replace(/ /g,"");
                                if (tag == "text"){
                                    document.getElementById(i.toString()).innerHTML = document.getElementById(i.toString()).innerHTML +
                                    "<div class=\"row-fluid\">" + 
                                    "<div id=\"" + upperHeading + "\"><h5>" + heading + "</h5><input id=\"" + upperHeading.toLowerCase() +
                                    "\"></div></div>" + "\n";
                                } else if (tag == "box"){
                                    document.getElementById(i.toString()).innerHTML = document.getElementById(i.toString()).innerHTML +
                                    "<div class=\"row-fluid\">" + 
                                    "<div id=\"" + upperHeading + "\"><h5>" + heading + "</h5><textarea id=\"" + upperHeading.toLowerCase() +
                                    "\" rows=\"5\" style=\"width:98%\"></textarea></div></div>" + "\n";
                                } else if (tag == "img"){
                                    document.getElementById(i.toString()).innerHTML = document.getElementById(i.toString()).innerHTML +
                                    "<div class=\"row-fluid\">" + 
                                    "<div><form enctype=\"multipart/form-data\" id=\"" + upperHeading + "\"><h5>" + heading + "</h5>" +
                                    "<input id=\"" + upperHeading.toLowerCase() + "\" style=\"display:inline;\" placeholder=\"Link\">" + 
                                    "<div style=\"font-weight:bold; font-size:15px; display:inline; padding-left:6px; padding-right:6px;\"> or <br></div>" +
                                    "<input type=\"file\" id=\"" + upperHeading.toLowerCase() + "Alt" + "\" name=\"" + upperHeading.toLowerCase() +
                                    "\" accept=\"image/jpg, image/png, application/pdf\" style = \"display:inline; padding-top:12px;\"><p style = \"display:inline; padding-top:0px; padding-left:-70px;\">*Note: File must have extension .jpg, .png, or .pdf</p></div></div>" + "\n";
                                } else if (tag == "menu"){
                                    menuCount = field.match(/,/g);
                                    var item = field.split(";");
                                    item = item[1].split(",");
                                    heading = field.substring(field.indexOf(">") + 1, field.indexOf(";"));
                                    heading = heading.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1);}).trim();
                                    upperHeading = heading.replace(/ /g,"");
                                    document.getElementById(i.toString()).innerHTML += "<div class=\"row-fluid\">" + 
                                    "<div id=\"" + upperHeading + "\"><h5>" + heading + "<br></h5>" + "<select id=\"" + upperHeading.toLowerCase() + "\"></select></div></div>";
                                    
                                    for(var l = 0; l <= menuCount.length; l++){
                                        item[l] = item[l].replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1);}).trim();
                                        document.getElementById(upperHeading.toLowerCase()).innerHTML += "<option>" + item[l] + "</option>";
                                    }

                                } else if (tag == "button"){
                                    buttonCount = field.match(/,/g);
                                    var item = field.split(";");
                                    item = item[1].split(",");
                                    heading = field.substring(field.indexOf(">") + 1, field.indexOf(";"));
                                    heading = heading.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1);}).trim();
                                    upperHeading = heading.replace(/ /g,"");
                                    document.getElementById(i.toString()).innerHTML += "<div class=\"row-fluid\">" + 
                                    "<div id=\"" + upperHeading + "\"><h5>" + heading + "<br></h5>" + "<form id=\"" + upperHeading.toLowerCase() + "\"></form></div></div>";
                                    
                                    for(var m = 0; m <= buttonCount.length; m++){
                                        item[m] = item[m].replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1);}).trim();
                                        document.getElementById(upperHeading.toLowerCase()).innerHTML += "<input type=\"radio\" id=\"" + item[m].replace(new RegExp(" ","g"),"").toLowerCase() + "\" value=\"" + item[m] + "\" name=\"" + heading + "\">" + item[m] + "<br>";
                                    }

                                } else if (tag == "check"){
                                    checkCount = field.match(/,/g);
                                    var item = field.split(";");
                                    item = item[1].split(",");
                                    heading = field.substring(field.indexOf(">") + 1, field.indexOf(";"));
                                    heading = heading.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1);}).trim();
                                    upperHeading = heading.replace(/ /g,"");
                                    document.getElementById(i.toString()).innerHTML += "<div class=\"row-fluid\">" + 
                                    "<div id=\"" + upperHeading + "\"><h5>" + heading + "<br></h5>" + "<form id=\"" + upperHeading.toLowerCase() + "\"></form></div></div>";
                                    
                                    for(var n = 0; n <= checkCount.length; n++){
                                        item[n] = item[n].replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1);}).trim();
                                        document.getElementById(upperHeading.toLowerCase()).innerHTML += "<input type=\"checkbox\" id=\"" + item[n].replace(new RegExp(" ","g"),"").toLowerCase() + "\" value=\"" + item[n] + "\" name=\"" + heading + "\">" + item[n] + "<br>";
                                    }

                                }
                                // else if (tag == "link"){
                                //     document.getElementById(i.toString()).innerHTML = document.getElementById(i.toString()).innerHTML +
                                //     "<div class=\"row-fluid\">" + //////////////////////////////////////////////////////////////////////////////
                                //     "<div id=\"" + camelHeading + "\"><h5>" + heading + "</h5><input id=\"" + camelHeading.toLowerCase() +
                                //     "\"></div></div>" + "\n";
                                // }
                            }

                            //forward and back buttons
                            if (i == 0){
                                document.getElementById(i.toString()).innerHTML = document.getElementById(i.toString()).innerHTML + "</div></div>" + 
                                "<button class=\"btn next\" style=\"margin-top:10px\"><strong>Next</strong></button>" + "\n";
                            } else if (i == (count.length - 1)){
                                document.getElementById(i.toString()).innerHTML = document.getElementById(i.toString()).innerHTML + "</div></div>" + 
                                "<button class=\"btn back\" style=\"margin-top:10px\"><strong>Back</strong></button>" + "\n";
                            } else{
                                document.getElementById(i.toString()).innerHTML = document.getElementById(i.toString()).innerHTML + "</div></div>" + 
                                "<button class=\"btn back\" style=\"margin-top:10px\"><strong>Back</strong></button>" + "\n" + 
                                "<button class=\"btn next\" style=\"margin-top:10px\"><strong>Next</strong></button>" + "\n";
                            }
                            
                        }
                        //make datasheet button
                        document.getElementById('wellTabs').innerHTML = document.getElementById('wellTabs').innerHTML +
                        "<li id=\"viewButton\"><button class=\"btn btn-success\" id=\"designButton\" onclick=\"makeDatasheet()\" style=\"width:100%\">Make Datasheet</button></li>";
                    };
                    $('#output').show();
                }

                var blob = file.slice(start, stop);
                reader.readAsText(blob);

            };
        </script>
        <script>
        function placeLink(){
            $.get("ParserServlet",function(data) {
                console.log(data);
                if(data.filename)
                {
                    alert("Success!!");
                }
            //use data to fill out parts of the form.
            //console.log('called');
                alert("Data is: " + data.filename);

                $("#dataLink").action(data.filename);
            }, "json" );
        }
        </script>
        <script>
            function makeDatasheet(){

                    var line, start, end, title, k, v;
                    var titleCount = 0;
                    var dataPairs = "{";
                    var idNames = idString.split("\n");

                    for (var i = 0; i < idNames.length; i++) {
                        line = idNames[i];
                        if(line.indexOf("<title>") != -1){

                            start = line.indexOf("<title>") + 7;
                            end = line.indexOf("</title>");
                            title = line.substring(start, end).trim();

                            dataPairs += "\"title" + ++titleCount + "\":\"" + title + "\",";
                        
                        }

                        if(line.indexOf("<text>") != -1){

                            start = line.indexOf("<text>") + 6;
                            end = line.indexOf("</text>");
                            k = line.substring(start, end).trim();

                            idValue = k.replace(new RegExp(" ","g"),"").toLowerCase().trim();
                            v = document.getElementById(idValue).value;

                            if (v == undefined){v = "";}

                            if(line.indexOf("*") != -1){
                                if(v == ""){
                                    alert("Please fill in required fields!");
                                    return;
                                }
                            }

                            dataPairs += "\"" + k + "\":\"" + v + "\",";

                        }

                        if(line.indexOf("<box>") != -1){

                            start = line.indexOf("<box>") + 5;
                            end = line.indexOf("</box>");
                            k = line.substring(start, end).trim();

                            idValue = k.replace(new RegExp(" ","g"),"").toLowerCase().trim();
                            v = document.getElementById(idValue).value;

                            if (v == undefined){v = "";}

                            if(line.indexOf("*") != -1){
                                if(v == ""){
                                    alert("Please fill in required fields!");
                                    return;
                                }
                            }

                            dataPairs += "\"" + k + "\":\"" + v + "\",";

                        }

                        if(line.indexOf("<img>") != -1){

                            start = line.indexOf("<img>") + 5;
                            end = line.indexOf("</img>");
                            k = line.substring(start, end).trim();

                            

                            idValue = k.replace(new RegExp(" ","g"),"").toLowerCase().trim();
                            v = document.getElementById(idValue).value;

                            // if (v == ""){
                            //     continue;
                            // }

                            if ((v == undefined || v == "") && document.getElementById(idValue + "Alt").value != "")
                            {
                                v = "";
                                k = "<imgupload>" + k;
                            }
                            else if (v != undefined && v != "")
                            {
                                k = "<imglink>" + k;
                            }

                            if(line.indexOf("*") != -1 && document.getElementById(idValue + "Alt").value == ""){
                                if(v == ""){
                                    alert("Please fill in required fields!");
                                    return;
                                }
                            }

                            dataPairs += "\"" + k + "\":\"" + v + "\",";

                        }

                        if(line.indexOf("<menu>") != -1){

                            start = line.indexOf("<menu>") + 6;
                            end = line.indexOf(";");
                            k = line.substring(start, end).trim();

                            idValue = k.replace(new RegExp(" ","g"),"").toLowerCase().trim();
                            v = document.getElementById(idValue).value;

                            if (v == undefined){v = "";}

                            if(line.indexOf("*") != -1){
                                if(v == ""){
                                    alert("Please fill in required fields!");
                                    return;
                                }
                            }

                            dataPairs += "\"" + k + "\":\"" + v + "\",";

                        }

                        if(line.indexOf("<check>") != -1){

                            start = line.indexOf("<check>") + 7;
                            end = line.indexOf(";");
                            k = line.substring(start, end).trim();

                            // idValue = k.replace(new RegExp(" ","g"),"").toLowerCase().trim();
                            // v = document.getElementById(idValue).value;

                            // if (v == undefined){v = "";}

                            // if(line.indexOf("*") != -1){
                            //     if(v == ""){
                            //         alert("Please fill in required fields!");
                            //         return;
                            //     }
                            // }


                            v = undefined;

                            vals = line.substring(line.indexOf(";") + 1,line.indexOf("</check>")).trim();
                            valArray = vals.split(",");

                            for(var j = 0; j < valArray.length; j++)
                            {

                                if(document.getElementById(valArray[j].trim()).checked && v != undefined)
                                {
                                    v = v + ", " + document.getElementById(valArray[j].trim()).value;
                                }
                                else if(document.getElementById(valArray[j].trim()).checked)
                                {
                                    v = document.getElementById(valArray[j].trim()).value;
                                } 
                            }

                            if(line.indexOf("*") != -1){
                                if(v == undefined){
                                    alert("Please fill in required fields!");
                                    return;
                                }
                            }

                            if (v == undefined){v = "";}

                            dataPairs += "\"" + k + "\":\"" + v + "\",";

                        }

                        if(line.indexOf("<button>") != -1){

                            start = line.indexOf("<button>") + 8;
                            end = line.indexOf(";");
                            k = line.substring(start, end).trim();

                            v = undefined;

                            vals = line.substring(line.indexOf(";") + 1,line.indexOf("</button>")).trim();
                            valArray = vals.split(",");

                            for(var j = 0; j < valArray.length; j++)
                            {
                                if(document.getElementById(valArray[j].trim()).checked)
                                {
                                    v = document.getElementById(valArray[j].trim()).value;
                                    break;
                                }
                            }

                            if(line.indexOf("*") != -1){
                                if(v == undefined){
                                    alert("Please fill in required fields!");
                                    return;
                                }
                            }

                            if (v == undefined){v = "";}

                            dataPairs += "\"" + k + "\":\"" + v + "\",";
                        }
                    }
                    
                    dataPairs = dataPairs.substring(0, (dataPairs.length -1));
                    dataPairs += "}";

                    alert(dataPairs);

                    $.post("ParserServlet", {"mode":"makeLatex","latex": dataPairs}, function(data) {

                            //use data to populate dynamic form after posting it to server for safe keeping
                            //window.location.replace("dynamicForm.html");
                            //page will redirect from server
                        });

                    document.getElementById('wellTabs').innerHTML += "<li style=\"margin-top:10px\"><form method=\"link\" id=\"dataLink\" action=\"http://www.google.com\" style=\"margin-bottom:0px\">\n" +
                    "<input type=\"submit\" value =\"View Datasheet\" class =\"btn btn-success\" style=\"width:100%\"></form></li>"
                    document.getElementById('viewButton').innerHTML = "<button class=\"btn btn-success\" id=\"designButton\" onclick=\"changeDatasheet()\"" + 
                    "style=\"width:100%\">Make Datasheet</button>";

                    placeLink();
                    // if(document.getElementById('dataLink'))
                    // {
                    //     $.get("ParserServlet",function(data) {
                    //         if(data["filename"])
                    //         {
                    //             alert("Success!!");
                    //         }
                    //     //use data to fill out parts of the form.
                    //     //console.log('called');
                    //         alert("Data is: " + data.filepath);

                    //         $("#dataLink").action(data.filepath);
                    //     });
                    // }
                    
        }
        </script>
        <script>
        function changeDatasheet(){
            document.getElementById('dataLink').action = "http://wikipedia.org/";
        }
        </script>

              
        <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script> 
        <script src="//netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>
        <script>
            $.get("ParserServlet", function(data) {
                //console.log(data);
                if (data.name)
                {
                    $("#name").val(data.name);
                    $("#deviceName").val(data.name);
                }
                if (data.summary)
                {
                    $("#summary").val(data.summary);
                }
                if (data.contactInformation.authors)
                {
                    $("#authors").val(data.contactInformation.authors);
                }
                if (data.sequence)
                {
                    $("#sequence").val(data.sequence);
                }
                if (data.designInformation.date)
                {
                    $("#date").val(data.designInformation.date);
                }
                if (data.designInformation.deviceType)
                {
                    $("#deviceType").val(data.designInformation.deviceType);
                }
            });
        </script>
        
        <!--scripts placed at the end to enhance page loading speed--> 
        <script type="text/javascript" src="libraries/jquery-1.9.1.min.js"></script> 
        <script src="libraries/bootstrap.min.js"></script>         
        <script>
           if ($('#restSel:checked').val() === "ON") {
            $('#restrictionMap').removeClass("hidden");
                }
         if ($('#flowSel:checked').val() === "ON") {
            $('#functionalityAssays').removeClass("hidden");

        }
          if ($('#otherSel:checked').val() === "ON") {
            //append new assay code
            $('#otherAssay').removeClass("hidden");       
        }
            function getCookie(c_name) {
                var c_value = document.cookie;
                var c_start = c_value.indexOf(" " + c_name + "=");
                if (c_start === -1) {
                    c_start = c_value.indexOf(c_name + "=");
                }
                if (c_start === -1) {
                    c_value = null;
                }
                else {
                    c_start = c_value.indexOf("=", c_start) + 1;
                    var c_end = c_value.indexOf(";", c_start);
                    if (c_end === -1) {
                        c_end = c_value.length;
                    }
                    c_value = unescape(c_value.substring(c_start, c_end));
                }
                return c_value;
            }

            function deleteCookie(key) {
                // Delete a cookie by setting the date of expiry to yesterday
                date = new Date();
                date.setDate(date.getDate() - 1);
                document.cookie = escape(key) + '=;expires=' + date;
            }

            if (getCookie("authenticate") !== "authenticated") {
                deleteCookie("user");
            }

            if (getCookie("authenticate") === "authenticated") {
                $('#loginArea').html('<p class="pull-right" style="margin-top:10px">You are logged in as <strong>' + getCookie("user") + '</strong> <a id="logout">Log Out</a></p>');
                $('#logout').click(function() {
                    $.get("AuthenticationServlet", {"command": "logout"}, function() {
                        deleteCookie("authenticate");
                        deleteCookie("user");
                        window.location.replace("index.html");
                    });
                });
            }
            $('#loginForm').submit(function(e) {
                var self = this;
                e.preventDefault();
                if ($('#loginForm input[name="user"]').val() === "") {
                    $('#loginModal').modal();
                } else if ($('#loginForm input[name="password"]').val() === "") {
                    $('#loginModal').modal();
                } else {
                    self.submit();
                }
            });
            $('#loginForm').submit(function(e) {
                var self = this;
                e.preventDefault();
                if ($('#loginFormMain input[name="user"]').val() === "") {
                    $('#loginModal').modal();
                } else if ($('#loginForm input[name="password"]').val() === "") {
                    $('#loginModal').modal();
                } else {
                    self.submit();
                }
            });
        </script>

        <footer>
            <div class="container" align="center">
                <p>Designed and built by <a href="http://2013.igem.org/Team:BostonU">BU iGEM Team</a> at <a href="http://cidarlab.org">CIDAR</a></p>
                <p>Code licensed under <a href="license.html">LICENSE</a></p>
            </div>
        </footer>

        <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script> 
        <script src="//netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>
        <script src="javascript/dynamicFormController.js"></script>

    </body>
</html>


